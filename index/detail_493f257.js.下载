$(function(){function e(){var e=$.Deferred();gCommentListViewConfig.defer=e,e.done(function(e){e&&$(".J-comment-count").text(e.total_number||0)}).always(function(){regLoadMoreEvent("comment-listview","loadmore-comments",gCommentListViewConfig),"#to-comments"==location.hash&&(location.hash="comments")}),listener.trigger("com.neihanshequ","comment-listview","loadcomments",gCommentListViewConfig)}function t(e){var t="comment_id",n=e.indexOf(t),r=e.indexOf(" ",n+t.length),o=e.substring(n+t.length,r);return o=o.replace("=","").replace(/"/g,"")}function n(e){var t=$("#syncToPlatformSelector");s(t,e)}function r(){var e=$("#text"),t=e.val(),n=t.length,r=i-n;$(".words-remain-wrapper .words").text(r)}function o(e,t){t>0?e.attr("href","/p"+t+"/").show():e.parents(".next-item").hide()}function a(){e();var a=getCurrentUser().platform||"[]",s=JSON.parse(a);n(s),listener.on("com.neihanshequ.user","change",function(e,t){t=t||{};var r=t.avatar_url||"//s3a.pstatp.com/resource/neihan_web/static/image/site-v2/default-me_3c7ec40.png";$("#currentUserAvatar").attr("src",r);var o=t.platform||[];n(o)}),$("#syncToPlatformSelector li").click(function(e){if(!checkUserLogin())return!1;var t=$(e.currentTarget),r=t.data("type"),o=getPlatform();-1!=$.inArray(r,o)?t.hasClass("selected")?t.removeClass("selected"):t.addClass("selected"):CommonUserUtil.loginByOther(r,{openWindow:!0,successCb:function(e){var t=e.platform;n(t)}})}),$("#postCommentForm").submit(function(){if(!checkUserLogin())return!1;var e=this,n=$("#text").val();if(n.length>i)return listener.trigger("com.neihanshequ","popupTip",{text:"您写的太多啦，字数上限是"+i+"哦！"}),!1;if(n=$.trim(n),!n.length)return listener.trigger("com.neihanshequ","popupTip",{text:"评论内容不能为空"}),!1;var r=$("#syncToPlatformSelector").find("li.selected"),o=[];return r.each(function(e,t){o.push($(t).data("type"))}),$(this).ajaxSubmit({data:{platform:o.join(",")},success:function(n){if("success"==n.message){var r=$("#replyToCommentId").attr("data-replyToContent"),o=t(n.data),a=((new Date).format("yy-MM-dd hh:mm"),getCurrentUser().name||""),i=$(e).find("#text").val(),s=$("#tmplNode").clone(!0);s.find(".name").text(a);var m=s.find(".time").attr("title",+new Date);s.find("p").text(i+r),s.find(".options").attr("data-comment-id",o),s.removeClass("hidden");var c=$("#comments").find(".comments");c.find(".comment-list").prepend(s),c.find(".J-comments-count").text(function(){return parseInt($(this).text())+1}),m.timeago();var l=$("#text").attr("data-defaultholder");$("#text").attr("placeholder",l),$("#text").val(""),$("#replyToCommentId").val(""),$("#replyToCommentId").attr("data-replyToContent","")}else{var d="";d="error"==n.message?n.data&&n.data.description?n.data.description:n.data||n.message:n.message,listener.trigger("com.neihanshequ","popupTip",{text:d})}}}),!1});var m="input";$.browser.msie&&$.browser.version<9&&(m="keyup"),$("#text").bind(m,function(){r()}).focus(function(){r()});var c=-1,l=-1;if("gStore"in window){var d=gStore.get(Constant.GROUP_ID_LIST_KEY_PREFIX);if(d){var u=null;try{u=JSON.parse(d)}catch(f){}u&&(c=getNextGroupId(u,gCommentListViewConfig.gid),l=getPrevGroupId(u,gCommentListViewConfig.gid))}o($("#prevGroupLink"),c),o($("#nextGroupLink"),l)}}var i=140,s=window.updatePlatform;a()});